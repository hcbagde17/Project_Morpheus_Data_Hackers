# ProctorWatch API Documentation

This document describes the internal APIs, IPC channels, and Database Schema used by the ProctorWatch system.

## 1. Electron IPC API (`window.electronAPI`)
These methods are exposed to the Renderer Process via `contextBridge` in `preload.cjs`.

### A. System Control
| Method | Type | Description | Returns |
| :--- | :--- | :--- | :--- |
| **`checkAdminStatus()`** | `invoke` | Checks if the application is running with Administrator privileges. | `Promise<boolean>` |
| **`restartAsAdmin()`** | `send` | Triggers a UAC prompt and restarts the application as Administrator. | `void` |
| **`getSystemInfo()`** | `invoke` | Returns basic OS info (Platform, CPU, Memory). | `Promise<SystemInfo>` |
| **`getScreenSources()`** | `invoke` | Returns available screens/windows for capture. | `Promise<Source[]>` |

### B. Proctoring & Enforcement
| Method | Type | Description |
| :--- | :--- | :--- |
| **`startEnforcement()`** | `send` | Starts the `EnforcementService` (Process Killer, Focus Lock, Clipboard Clean). |
| **`stopEnforcement()`** | `send` | Stops the `EnforcementService` and releases hooks. |
| **`startNetworkMonitor()`** | `send` | Starts the `SystemMonitor` for network/process scanning. |
| **`stopNetworkMonitor()`** | `send` | Stops the `SystemMonitor`. |
| **`onViolation(callback)`** | `listener` | Listens for `proctoring:violation` events from the Main process (e.g., Process Killed). |
| **`onNetworkRiskUpdate(callback)`** | `listener` | Listens for `proctoring:network-risk-update` events (e.g., VPN detected). |

---

## 2. Database Schema (Supabase)

### A. `exam_sessions`
Tracks the lifecycle of a student's attempt.
*   **`id`** (UUID): Primary Key.
*   **`status`** (enum): `'in_progress'`, `'submitted'`, `'terminated'`.
*   **`score`** (int): Final score (0 if terminated).
*   **`device_info`** (json): Browser UA, IP, Screen Res.

### B. `flags`
Stores all suspicious events generated by AI/System modules.
*   **`session_id`** (UUID): Foreign Key to `exam_sessions`.
*   **`flag_type`** (string): Error code (e.g., `GAZE_AWAY`, `PROCESS_KILLED`).
*   **`severity`** (enum): `'RED'`, `'ORANGE'`, `'GREEN'`.
*   **`module`** (string): Source module (e.g., `vision`, `enforcement`).
*   **`metadata`** (json): Additional context (e.g., blocked process name, risk score).
*   **`evidence_url`** (string): URL to video clip in Storage (if captured).

### C. `module_overrides`
Records admin actions to disable modules.
*   **`session_id`** (UUID): Target session.
*   **`admin_id`** (UUID): Admin who performed the override.
*   **`disabled_modules`** (text[]): Array of module IDs disabled (e.g., `['audio', 'enforcement']`).
*   **`reason`** (text): Justification for the override.

---

## 3. Frontend Services

### A. `MediaService` (`src/lib/proctoringService.js`)
Handles raw media streams.
*   **`start()`**: Requests `getUserMedia` (Video/Audio) + `getDisplayMedia` (Screen). Returns `MediaStream`.
*   **`stop()`**: Stops all tracks and releases hardware resources.

### B. `EvidenceCapture` (`src/lib/evidenceCapture.js`)
Manages video recording and upload.
*   **`start(stream)`**: Begins recording to a circular buffer (RAM).
*   **`captureForFlag(sessionId, flagId, duration)`**: Extracts the last `duration` seconds + future buffer and uploads to Supabase.
*   **`stop()`**: Clears buffer and stops recording.

### C. `VisionIntelligence` (`src/lib/visionIntelligence.js`)
*   **`processFrame(videoElement)`**: Runs FaceMesh inference on a single frame.
*   **`calculateScore(metrics)`**: Returns weighted risk score (0-100).
